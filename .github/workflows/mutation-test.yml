name: Mutation Testing & Rickroll

on:
  push:
    branches: [ '**' ]      # Allow all branches be triggered
  pull_request:
    branches: [ '**' ]      

jobs:
  mutation-testing:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository code
      - uses: actions/checkout@v4

      # 2. Set up JDK 17 (Standard for GraphHopper)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 3. Download Previous Score (Design Choice: Persistence)
      # We use 'dawidd6/action-download-artifact' because standard actions cannot 
      # download artifacts from *previous* workflow runs, only the current one.
      - name: Download previous mutation score
        id: download_score
        uses: dawidd6/action-download-artifact@v6
        with:
          name: mutation-score-report
          path: previous_data/
          if_no_artifact_found: warn # Start fresh if no history exists
          search_artifacts: true     # Search in previous successful runs

      # 3.5 Build the project first (New Step!)
      # We need to install 'core' and other modules to the local repository 
      # so 'web-bundle' can find its dependencies. We skip tests here to save time.
      - name: Build Project (Install Dependencies)
        run: mvn install -DskipTests -Dmaven.javadoc.skip=true

      # 4. Run PITest on web-bundle module only
      - name: Run PITest (Mutation Testing)
        run: |
          mvn -pl web-bundle org.pitest:pitest-maven:mutationCoverage

      # 5. Compare Scores and Fail if Dropped (Robust & Sanitized)
      - name: Check Mutation Score
        id: check_score
        run: |
          echo "Analyzing Mutation Score..."
          
          REPORT_PATH="web-bundle/target/pit-reports/mutations.xml"
          
          # 1. Validate Report Existence
          if [ ! -f "$REPORT_PATH" ]; then
            echo "::error::PITest report not found at $REPORT_PATH."
            exit 1
          fi

          # 2. Extract Data (with fallbacks)
          TOTAL=$(grep -c "<mutation" "$REPORT_PATH" || echo 0)
          KILLED=$(grep -c 'status="KILLED"' "$REPORT_PATH" || echo 0)
          
          echo "Debug: Total Mutations: $TOTAL, Killed: $KILLED"

          # 3. Calculate Current Score
          if [ "$TOTAL" -gt 0 ]; then
             CURRENT_SCORE=$(( 100 * KILLED / TOTAL ))
          else
             echo "Warning: Total mutations is 0. Defaulting score to 0."
             CURRENT_SCORE=0
          fi
          
          echo "Current Score Calculated: $CURRENT_SCORE"

          # 4. Retrieve & Sanitize Previous Score
          PREV_SCORE=0
          SCORE_FILE="previous_data/score.txt"
          
          if [ -f "$SCORE_FILE" ]; then
            RAW_CONTENT=$(cat "$SCORE_FILE")
            # Use regex to check if content is a valid integer. If not, ignore it.
            if [[ "$RAW_CONTENT" =~ ^[0-9]+$ ]]; then
              PREV_SCORE=$RAW_CONTENT
            else
              echo "Warning: Corrupted score file content '$RAW_CONTENT'. Resetting baseline to 0."
            fi
          fi
          
          echo "Previous Valid Score: $PREV_SCORE"

          # 5. Save Current Score (for next run)
          echo "$CURRENT_SCORE" > score.txt

          # 6. Compare Logic
          if (( CURRENT_SCORE < PREV_SCORE )); then
            echo "::error::Mutation score dropped from $PREV_SCORE% to $CURRENT_SCORE%!"
            exit 1
          else
            echo "âœ… Success! Mutation score is stable or improved ($CURRENT_SCORE% >= $PREV_SCORE%)."
          fi
          
      # 6. Upload Current Score as Artifact (Persistence)
      # "always()" ensures this runs even if the test failed, 
      # but logically we only want to update the baseline if we decide that is the policy.
      # Here we upload it so the next run knows the latest state.
      - name: Save mutation score
        if: always() 
        uses: actions/upload-artifact@v4
        with:
          name: mutation-score-report
          path: score.txt
          overwrite: true

      # 7. Rickroll on Failure (TÃ¢che 5)
      # This step only runs if any previous step failed (if: failure())
      - name: Rickroll Payload
        if: failure()
        run: |
          echo "=================================================="
          echo "ðŸš« BUILD FAILED! YOU KNOW THE RULES, AND SO DO I ðŸš«"
          echo "=================================================="
          echo "ðŸŽµ Never gonna give you up"
          echo "ðŸŽµ Never gonna let you down"
          echo "ðŸŽµ Never gonna run around and desert you"
          echo "=================================================="
          echo "Open for a surprise: https://www.youtube.com/watch?v=dQw4w9WgXcQ"